<!DOCTYPE html>
<html>
  <head>
    <title>Dustbin::Game MarbleGP - Championship Result</title>
    <link href="jquery-ui.min.css" rel="stylesheet">
    <link href="jquery-ui.structure.min.css" rel="stylesheet">
    <link href="jquery-ui.theme.min.css" rel="stylesheet">
    <link href="jquery.treemenu.min.css" rel="stylesheet">
    <style>
      
      #mainframe, #headline {
        width: 80%;
        border-radius: 1em;
        border: 2px solid black;
        background-color: rgba(224, 224, 244, 128);
        padding: 1em;
      }
      
      #headline {
        height: 5vh;
        margin-bottom: 1em;
        text-align: center;
        vertical-align: middle;
        font-size: 1.5em;
        font-weight: bold;
        overflow: hidden;
      }
      
      .container {
        display: flex;
        justify-content: center;
        position: relative;
      }
      
      body {
        background-image: url("background.jpg");
        background-repeat: no-repeat;
        background-size: cover;
        background-attachment: fixed;
        background-position: center; 
        font-family: Arial;
      }
      
      table {
        width: 100%;
      }
      
      td, th {
        border-bottom: 1px solid black;
        margin: 0.1em;
        padding: 0.1em;
      }
      
      .logoimg {
        height: 5em;
        width: auto;
        padding: 0px;
        margin: 0px;
      }
      
      table, tr {
        padding: 0px;
        margin: 0px;
        border: 0px;
      }
      
      .button {
        border: 2px solid black;
        border-radius: 0.5em;
        width: 20em;
        height: 1.5em;
        background-color: #b8c8ff;
        margin-bottom: 1em;
        text-align: center;
        padding-top: auto;
        padding-bottom: auto;
        font-size: 2em;
        line-height: 1.5em;
        cursor: pointer;
        color: #000000;
        text-decoration: none;
      }
      
      .button:hover { background-color: #3367b8; }
      .button:active { background-color: #ecf163; }
      
      .thumbnail {
        width: 50%;
        height: auto;
      }
      
      a {
        text-decoration: none;
      }
      
      .td_rght {
        text-align: right;
      }
      
      .td_cntr {
        text-align: center;
      }
      
    </style>
    <script src="jquery.js" type="text/javascript"></script>
    <script src="jquery-ui.min.js" type="text/javascript"></script>
    <script>
      
      g_TrackNames = {!tracknames};
      
      g_Championship = {!championship};
      
      function makeAiCell(a_Ai) {
        var l_Html = "<td style=\"text-align: center; ";
        
        switch (a_Ai) {
          case "marblegp": l_Html += " background-color: #FF0000"; break;
          case "marble2" : l_Html += " background-color: #FF8000"; break;
          case "marble3" : l_Html += " background-color: #FFFF00"; break;
          default: break;
        }
        
        l_Html += "\">";
        if (a_Ai == "") l_Html += "&nbsp;"; else l_Html += a_Ai;
        l_Html += "</td>\n";
        
        l_Html += "      </tr>\n";
        return l_Html;
      }
      
      $(document).ready(function() {
        var l_MainFrame = $("#mainframe");
        
        var l_Html = "<a href=\"/championship.xml\" target=\"_blank\" id=\"JSON_download\">Download plain result JSON</a><br />";
        l_Html += "  <h3>Setup</h3>\n";
        l_Html += "  <div><ul>\n";
        l_Html += "    <li><b>Race Class:</b> ";
        
        switch (g_Championship.class) {
          case 0: l_Html += "Marble3"; break;
          case 1: l_Html += "Marble3 + Marble2"; break;
          case 2: l_Html += "Marble2"; break;
          case 3: l_Html += "Marble2 + MarbleGP"; break;
          case 4: l_Html += "MarbleGP"; break;
          case 5: l_Html += "All Classes"; break;
          default: l_Html += g_Championship.class;
        }
        
        l_Html += "</li>\n";
        l_Html += "    <li><b>Grid Size:</b> " + g_Championship.gridsize + "</li>\n";
        l_Html += "    <li><b>Grid Order:</b> ";
        
        switch (g_Championship.gridorder) {
          case 0: l_Html += "Fixed (All races have the same starting order)"; break;
          case 1: l_Html += "Last Race "; if (g_Championship.reversegrid) l_Html += "Reverse Grid (Winner of the last race starts from the end)"; else l_Html += "Winner of the last race starts from pole position)"; break;
          case 2: l_Html += "Standings "; if (g_Championship.reversegrid) l_Html += "Reverse Grid (Leader of the chanpionship starts from the end)"; else l_Html += "Leader of the championship starts from pole position)"; break;
          case 3: l_Html += "Random"; break;
        }
        
        l_Html += "</li>\n";
        
        var l_Players = g_Championship.players;

        l_Html += "  </ul></div>\n";
        l_Html += "  <h3>Final Result</h3>\n";
        l_Html += "  <div>\n";
        l_Html += "    <table>\n";
        l_Html += "      <tr>\n";
        l_Html += "        <th rowspan=\"2\">Pos</th>\n";
        l_Html += "        <th rowspan=\"2\">Name</th>\n";
        l_Html += "        <th rowspan=\"2\">Points</th>\n";
        l_Html += "        <th rowspan=\"2\">Respawn</th>\n";
        l_Html += "        <th rowspan=\"2\">Stunned</th>\n";
        l_Html += "        <th rowspan=\"2\">Fastest&nbsp;Laps</th>\n";
        l_Html += "        <th rowspan=\"2\">D.N.F.</th>\n";
        l_Html += "        <th rowspan=\"2\">Best&nbsp;Race</th>\n";
        l_Html += "        <th colspan=\"16\">Race Results</th>\n";
        l_Html += "        <th rowspan=\"2\">AI&nbsp;Class</th>\n";
        l_Html += "      </tr>";
        l_Html += "      <tr>";
        
        for (i = 1; i <= 16; i++) {
          l_Html += "        <th>" + i + "</th>\n";
        }
        
        l_Html += "      </tr>";
        
        g_Championship.players.sort(function(a_Player1, a_Player2) {
          if (a_Player1["points"] != a_Player2["points"]) {
            return a_Player2["points"] - a_Player1["points"];
          }
          else if (a_Player1["respawn"] != a_Player2["respawn"]) {
            return a_Player1["respawn"] - a_Player2["respawn"];
          }
          else if (a_Player1["stunned"] != a_Player2["stunned"]) {
            return a_Player1["stunned"] - a_Player2["stunned"];
          }
          else if (a_Player1["fastest_laps"] != a_Player2["fastest_laps"]) {
            return a_Player1["fastest_laps"] - a_Player2["fastest_laps"];
          }
          else if (a_Player1["did_not_finish"] != a_Player2["did_not_finish"]) {
            return a_Player2["did_not_finish"] - a_Player1["did_not_finish"];
          }
          else if (a_Player1["first_best_finish"] != a_Player2["first_best_finish"]) {
            return a_Player2["first_best_finish"] - a_Player1["first_best_finish"];
          }
        });
        
        var l_Pos = 1;
        
        for (i = 0; i < g_Championship.players.length; i++) {
          var l_Player = g_Championship.players[i];
          var l_Name   = l_Player.name;
          var l_Ai     = "";
          
          if (l_Name.indexOf("|") != -1) {
            l_Ai   = l_Name.substr(   l_Name.indexOf("|") + 1);
            l_Name = l_Name.substr(0, l_Name.indexOf("|")    );
            
            l_Player.name = l_Name;
            l_Player.ai   = l_Ai;
          }
          else l_Player.ai = "";

          
          l_Html += "      <tr>\n";
          l_Html += "        <td style=\"text-align: center\">" + l_Pos + "</td>\n";
          l_Html += "        <td>" + l_Name + "</td>\n";
          l_Html += "        <td style=\"text-align: right\">"  + l_Player.points            + "</td>\n";
          l_Html += "        <td style=\"text-align: center\">" + l_Player.respawn           + "</td>\n";
          l_Html += "        <td style=\"text-align: center\">" + l_Player.stunned           + "</td>\n";
          l_Html += "        <td style=\"text-align: center\">" + l_Player.fastest_laps      + "</td>\n";
          l_Html += "        <td style=\"text-align: center\">" + l_Player.did_not_finish    + "</td>\n";
          l_Html += "        <td style=\"text-align: center\">" + l_Player.first_best_finish + "</td>\n";
          
          for (j = 0; j < 16; j++) {
            if (l_Player.race_results[j] != undefined)
              l_Html += "        <td style=\"text-align: center\">" + l_Player.race_results[j] + "</td>\n";
            else
              l_Html += "        <td>&nbsp;</td>\n";
          }
          
          l_Html += "        " + makeAiCell(l_Ai);
          l_Html += "      </tr>\n";
          
          l_Pos++;
        }
        
        l_Html += "    </table>\n";
        l_Html += "  </div>\n";
        l_Html += "</div>\n";
        l_Html += "<h3>Races</h3>\n";
        l_Html += "<div id=\"accordion\">\n";
        
        for (i = 0; i < g_Championship.races.length; i++) {
          var l_ThisRace = g_Championship.races[i];
          
          l_Html += "  <h3>Race " + (i + 1) + ": <b>" + g_TrackNames[l_ThisRace.track] + "</b> (" + l_ThisRace.laps;
          if (l_ThisRace.laps == 1) l_Html += " Lap, " ; else l_Html += " Laps, ";
          l_Html += l_ThisRace.playercount + " Marbles)</h3>\n";
          
          l_Html += "  <div>\n";
          l_Html += "    <img src=\"/thumbnails/" + l_ThisRace.track + "\" alt=\"Thumbnail " + g_TrackNames[l_ThisRace.track] + "\" class=\"thumbnail\" /><br />\n";
          l_Html += "    <table>\n";
          l_Html += "      <tr>\n";
          l_Html += "        <th>Position</th>\n";
          l_Html += "        <th>Name</th>\n";
          l_Html += "        <th>Racetime</th>\n";
          l_Html += "        <th>Respawn</th>\n";
          l_Html += "        <th>Stunned</th>\n";
          l_Html += "        <th>Best&nbsp;Lap&nbsp;Time</th>\n";
          l_Html += "        <th>Lag&nbsp;(Leader)</th>\n";
          l_Html += "        <th>Lag&nbsp;(Player Ahead)</th>\n";
          l_Html += "        <th>AI&nbsp;Class</th>\n";
          l_Html += "      </tr>\n";
          
          var l_Assignment = l_ThisRace.marble_assignment;
          var l_CpCount    = l_ThisRace.result[0].laps[l_ThisRace.result[0].laps.length - 1].length;
          
          for (j = 0; j < l_ThisRace.result.length; j++) {
            var l_ThisResult = l_ThisRace.result[j];
            
            var l_Name = l_ThisResult.id;
            var l_Ai   = "";
            
            if (l_Assignment[l_Name] != undefined) {
              l_Name = l_Assignment[l_Name];
              
              for (k = 0; k <  g_Championship.players.length; k++) {
                if (g_Championship.players[k].playerid == l_Name) {
                  l_Name = g_Championship.players[k].name;
                  l_Ai   = g_Championship.players[k].ai;
                  break;
                }
              }
            }
            else console.log("Assignment undefined (" + l_Name + ")!");
            
            l_Html += "      <tr>\n";
            l_Html += "        <td>" + (j + 1) + "</td>\n";
            l_Html += "        <td>" + l_Name + "</td>\n";
            l_Html += "        <td class=\"td_rght\">";
            var l_RaceTime = l_ThisResult.racetime;
            
            var l_NotFinished = l_RaceTime <= 0 || l_ThisResult.laps.length < l_ThisRace.laps || l_ThisResult.laps[l_ThisResult.laps.length - 1].length < l_CpCount;
            
            if (l_NotFinished) {
              l_Html += "Did&nbsp;not&nbsp;Finish";
            }
            else {
              l_Html += (l_ThisResult.racetime / 120).toFixed(2) + "&nbsp;sec.";
            }
            
            l_Html += "</td>\n";
            l_Html += "      <td class=\"td_cntr\">" + l_ThisResult.respawn + "</td>\n";
            l_Html += "      <td class=\"td_cntr\">" + l_ThisResult.stunned + "</td>\n";
            
            if (l_ThisResult.fastest > 0)
              l_Html += "      <td class=\"td_rght\">" + (l_ThisResult.fastest / 120.0).toFixed(2) + "&nbsp;sec.</td>\n";
            else
              l_Html += "      <td class=\"td_rght\">No&nbsp;Laptime&nbsp;Set</td>\n";
            
            if (l_ThisResult.deficit == 0 || l_NotFinished)
              l_Html += "      <td>&nbsp;</td>\n";
            else if (l_ThisResult.deficit > 0)
              l_Html += "      <td class=\"td_rght\">" + (l_ThisResult.deficit / 120.0).toFixed(2) + "&nbsp;sec.</td>\n";
            else {
              if (l_ThisResult.deficit == -1)
                l_Html += "      <td class=\"td_rght\">+1&nbsp Lap</td>";
              else
                l_Html += "      <td class=\"td_rght\">+" + (-l_ThisResult.deficit) + "&nbsp;Laps</td>";
            }
            
            l_Html += "      <td class=\"td_rght\">";
            
            if (j == 0)
              l_Html += "&nbsp;";
            else {
              var l_Lap = l_ThisResult.laps.length - 1;
              var l_Cp  = l_ThisResult.laps[l_Lap].length - 1;
              
              if (l_ThisRace.result[j - 1].laps[l_Lap].length <= l_Cp)
                l_Cp = l_ThisRace.result[j - 1].laps[l_Lap].length - 1
              
              l_Html += ((l_ThisResult.laps[l_Lap][l_Cp] - l_ThisRace.result[j - 1].laps[l_Lap][l_Cp]) / 120.0).toFixed(2) + "&nbsp;sec.";
            }
            
            l_Html += "</td>\n";
            l_Html += "         " + makeAiCell(l_Ai) + "\n";
            l_Html += "      </tr>\n";
          }
          
          l_Html += "    </table>\n";
          l_Html += "  </div>\n";
        }
        
        l_MainFrame.html(l_Html);
        
        $("#accordion").accordion();
        
        var l_Data = new Blob([ JSON.stringify(g_Championship) ], { type: "text/json" });
        var l_Url  = window.URL.createObjectURL(l_Data);
        
        console.log(l_Data);
        
        document.getElementById("JSON_download").href = l_Url;
      });
    
    </script>
  </head>
  <body>
    <div class="container">
      <div id="headline">
        Dustbin::Games MarbleGP - Result of last Championship [<a href="#" onclick="history.back()">Main Menu</a>]
      </div>
    </div>
    <div class="container">
      <div id="mainframe">
      </div>
    </div>
    <div class="container" style="padding-top: 1em"><img src="marblegp_logo.png" class="logoimg" /></div>
  </body>
</html>
