<!DOCTYPE html>
<html>
  <head>
    <title>Dustbin::Game MarbleGP - Championship Result</title>
    <link href="jquery-ui.min.css" rel="stylesheet">
    <link href="jquery-ui.structure.min.css" rel="stylesheet">
    <link href="jquery-ui.theme.min.css" rel="stylesheet">
    <link href="jquery.treemenu.min.css" rel="stylesheet">
    <style>
      
      #mainframe, #headline {
        width: 80%;
        border-radius: 1em;
        border: 2px solid black;
        background-color: rgba(224, 224, 244, 128);
        padding: 1em;
      }
      
      #headline {
        height: 5vh;
        margin-bottom: 1em;
        text-align: center;
        vertical-align: middle;
        font-size: 1.5em;
        font-weight: bold;
        overflow: hidden;
      }
      
      .container {
        display: flex;
        justify-content: center;
        position: relative;
      }
      
      body {
        background-image: url("background.jpg");
        background-repeat: no-repeat;
        background-size: cover;
        background-attachment: fixed;
        background-position: center; 
        font-family: Arial;
      }
      
      table {
        width: 100%;
      }
      
      td, th {
        border-bottom: 1px solid black;
        margin: 0.1em;
        padding: 0.1em;
      }
      
      .logoimg {
        height: 5em;
        width: auto;
        padding: 0px;
        margin: 0px;
      }
      
      table, tr {
        padding: 0px;
        margin: 0px;
        border: 0px;
      }
      
      .button {
        border: 2px solid black;
        border-radius: 0.5em;
        width: 20em;
        height: 1.5em;
        background-color: #b8c8ff;
        margin-bottom: 1em;
        text-align: center;
        padding-top: auto;
        padding-bottom: auto;
        font-size: 2em;
        line-height: 1.5em;
        cursor: pointer;
        color: #000000;
        text-decoration: none;
      }
      
      .button:hover { background-color: #3367b8; }
      .button:active { background-color: #ecf163; }
      
      .thumbnail {
        width: 50%;
        height: auto;
      }
      
      a {
        text-decoration: none;
      }
      
    </style>
    <script src="jquery.js" type="text/javascript"></script>
    <script src="jquery-ui.min.js" type="text/javascript"></script>
    <script>
      
      g_TrackNames = {!tracknames};
      
      g_Championship = '{!championship}';
      
      function getNodeValue(a_Node) {
        return a_Node[0].firstChild.nodeValue;
      }
    
      $(document).ready(function() {
        a_Data = $.parseXML(g_Championship);
        
        var l_MainFrame = $("#mainframe");
        var l_Settings = a_Data.getElementsByTagName("race_settings")[0];
        
        var l_Html = "<a href=\"/championship.xml\" target=\"_blank\">Download plain result XML</a><br />";
        l_Html += "  <h3>Setup</h3>\n";
        l_Html += "  <div><ul>\n";
        l_Html += "    <li><b>Race Class:</b> ";
        
        switch (getNodeValue(l_Settings.getElementsByTagName("class"))) {
          case "0": l_Html += "Marble3"; break;
          case "1": l_Html += "Marble3 + Marble2"; break;
          case "2": l_Html += "Marble2"; break;
          case "3": l_Html += "Marble2 + MarbleGP"; break;
          case "4":l_Html += "MarbleGP"; break;
          case "5": l_Html += "All Classes"; break;
          default: l_Html += getNodeValue(l_Settings.getElementsByTagName("class"));
        }
        
        l_Html += "</li>\n";
        l_Html += "    <li><b>Grid Size:</b> " + getNodeValue(l_Settings.getElementsByTagName("gridsize")) + "</li>\n";
        l_Html += "    <li><b>Grid Order:</b> ";
        
        var l_Reverse = getNodeValue(l_Settings.getElementsByTagName("reversegrid")) == "true";
        
        switch (getNodeValue(l_Settings.getElementsByTagName("gridorder"))) {
          case "0": l_Html += "Fixed (All races have the same starting order)"; break;
          case "1": l_Html += "Last Race "; if (l_Reverse) l_Html += "Reverse Grid (Winner of the last race starts from the end)"; else l_Html += "Winner of the last race starts from pole position)"; break;
          case "2": l_Html += "Standings "; if (l_Reverse) l_Html += "Reverse Grid (Leader of the chanpionship starts from the end)"; else l_Html += "Leader of the championship starts from pole position)"; break;
          case "3": l_Html += "Random"; break;
        }
        
        l_Html += "</li>\n";
        
        var l_Players = a_Data.getElementsByTagName("players");

        l_Html += "  </ul></div>\n";
        l_Html += "  <h3>Final Result</h3>\n";
        l_Html += "  <div>\n";
        l_Html += "    <table>\n";
        l_Html += "      <tr>\n";
        l_Html += "        <th rowspan=\"2\">Pos</th>\n";
        l_Html += "        <th rowspan=\"2\">Name</th>\n";
        l_Html += "        <th rowspan=\"2\">Points</th>\n";
        l_Html += "        <th rowspan=\"2\">Respawn</th>\n";
        l_Html += "        <th rowspan=\"2\">Stunned</th>\n";
        l_Html += "        <th rowspan=\"2\">Fastest&nbsp;Laps</th>\n";
        l_Html += "        <th rowspan=\"2\">D.N.F.</th>\n";
        l_Html += "        <th rowspan=\"2\">Best&nbsp;Race</th>\n";
        l_Html += "        <th colspan=\"16\">Race Results</th>\n";
        l_Html += "        <th rowspan=\"2\">AI Class</th>\n";
        l_Html += "      </tr>";
        l_Html += "      <tr>";
        
        for (i = 1; i <= 16; i++) {
          l_Html += "        <th>" + i + "</th>\n";
        }
        
        l_Html += "      </tr>";
        
        var l_PlayerList = [ ];
        
        for (l_Player of l_Players[0].childNodes) {
          if (l_Player.tagName == "player") {
            var l_Data = { };
            
            var l_Name = getNodeValue(l_Player.getElementsByTagName("name"));
            var l_Ai   = "";
            
            if (l_Name.indexOf("|") != -1) {
              l_Ai   = l_Name.substr(   l_Name.indexOf("|") + 1);
              l_Name = l_Name.substr(0, l_Name.indexOf("|")    );
            }
            
            l_Data["id"               ] = getNodeValue(l_Player.getElementsByTagName("playerid"));
            l_Data["name"             ] = l_Name;
            l_Data["ai"               ] = l_Ai;
            l_Data["points"           ] = getNodeValue(l_Player.getElementsByTagName("points"));
            l_Data["respawn"          ] = getNodeValue(l_Player.getElementsByTagName("respawn"));
            l_Data["stunned"          ] = getNodeValue(l_Player.getElementsByTagName("stunned"));
            l_Data["fastest_laps"     ] = getNodeValue(l_Player.getElementsByTagName("fastest_laps"));
            l_Data["did_not_finish"   ] = getNodeValue(l_Player.getElementsByTagName("did_not_finish"));
            l_Data["first_best_finish"] = getNodeValue(l_Player.getElementsByTagName("first_best_finish"));
            
            l_Data["results"] = [ ];
            
            for (l_Result of l_Player.getElementsByTagName("race_results")[0].childNodes) {
              if (l_Result.tagName == "position") {
                var l_Pos   = l_Result.getAttribute("pos");
                var l_Count = l_Result.firstChild.nodeValue;
                
                l_Data["results"][parseInt(l_Pos)] = parseInt(l_Count);
              }
            }
                          
            l_PlayerList.push(l_Data);
          }
        }
        
        l_PlayerList.sort(function(a_Player1, a_Player2) {
          if (a_Player1["points"] != a_Player2["points"]) {
            return a_Player2["points"] - a_Player1["points"];
          }
          else if (a_Player1["respawn"] != a_Player2["respawn"]) {
            return a_Player1["respawn"] - a_Player2["respawn"];
          }
          else if (a_Player1["stunned"] != a_Player2["stunned"]) {
            return a_Player1["stunned"] - a_Player2["stunned"];
          }
          else if (a_Player1["fastest_laps"] != a_Player2["fastest_laps"]) {
            return a_Player1["fastest_laps"] - a_Player2["fastest_laps"];
          }
          else if (a_Player1["did_not_finish"] != a_Player2["did_not_finish"]) {
            return a_Player2["did_not_finish"] - a_Player1["did_not_finish"];
          }
          else if (a_Player1["first_best_finish"] != a_Player2["first_best_finish"]) {
            return a_Player2["first_best_finish"] - a_Player1["first_best_finish"];
          }
        });
        
        var l_Pos = 1;
        
        for (l_Data of l_PlayerList) {
          l_Html += "      <tr>\n";
          l_Html += "        <td style=\"text-align: center\">" + l_Pos + "</td>\n";
          l_Html += "        <td>" + l_Data["name"             ] + "</td>\n";
          l_Html += "        <td style=\"text-align: right\">" + l_Data["points"           ] + "</td>\n";
          l_Html += "        <td style=\"text-align: center\">" + l_Data["respawn"          ] + "</td>\n";
          l_Html += "        <td style=\"text-align: center\">" + l_Data["stunned"          ] + "</td>\n";
          l_Html += "        <td style=\"text-align: center\">" + l_Data["fastest_laps"     ] + "</td>\n";
          l_Html += "        <td style=\"text-align: center\">" + l_Data["did_not_finish"   ] + "</td>\n";
          l_Html += "        <td style=\"text-align: center\">" + l_Data["first_best_finish"] + "</td>\n";
          
          for (i = 1; i <= 16; i++) {
            if (l_Data["results"][i] != undefined)
              l_Html += "        <td style=\"text-align: center\">" + l_Data["results"][i] + "</td>\n";
            else
              l_Html += "        <td>&nbsp;</td>\n";
          }
          
          l_Html += "        <td";
          
          switch (l_Data["ai"]) {
            case "marblegp": l_Html += " style=\"background-color: #FF0000\""; break;
            case "marble2" : l_Html += " style=\"background-color: #FF8000\""; break;
            case "marble3" : l_Html += " style=\"background-color: #FFFF00\""; break;
            default: break;
          }
          
          l_Html += ">";
          if (l_Data["ai"] == "") l_Html += "&nbsp;"; else l_Html += l_Data["ai"];
          l_Html += "</td>\n";
          
          l_Html += "      </tr>\n";
          
          l_Pos++;
        }
        
        l_Html += "    </table>\n";
        l_Html += "  </div>\n";
        l_Html += "<h3>Races</h3>\n";
        l_Html += "    <div id=\"accordion\">\n";
        
        var l_Races = a_Data.getElementsByTagName("races")[0];
        var l_Count = 1;
       
        for (l_Race of l_Races.childNodes) {
          if (l_Race.tagName == "race") {
            var l_Assignment = l_Race.getElementsByTagName("marble_assignment")[0];
            var l_Result     = l_Race.getElementsByTagName("result")[0];
            
            l_Html += "      <h3>Race " + l_Count + ": ";
            
            var l_TrackId = getNodeValue(l_Race.getElementsByTagName("track"));
            var l_Laps    = getNodeValue(l_Race.getElementsByTagName("laps"));
            var l_Marbles = getNodeValue(l_Race.getElementsByTagName("playercount"));
            
            var l_Track = l_TrackId;
            
            if (g_TrackNames != undefined && g_TrackNames[l_Track] != undefined)
              l_Track = g_TrackNames[l_Track];
            
            l_Html += "<b>" + l_Track + "</b>, " + l_Laps + ", ";
            
            if (l_Laps == "1") l_Html += " lap"; else l_Html += " laps";
            
            l_Html += ", " + l_Marbles + " Marbles";
            l_Html += "</h3>";
            l_Html += "      <div>\n";
            l_Html += "        <img src=\"/thumbnails/" + l_TrackId + "\" alt=\"Tumbnail of track &quot;" + l_Track + "&quot;\" class=\"thumbnail\" /><br />\n";
            l_Html += "        <table>\n";
            l_Html += "          <tr>\n";
            l_Html += "            <th>Position</th>\n";
            l_Html += "            <th>Player</th>\n";
            l_Html += "            <th>Respawn</th>\n";
            l_Html += "            <th>Stunned</th>\n";
            l_Html += "            <th>Racetime</th>\n";
            l_Html += "            <th>Fastest&nbsp;Laptime</th>\n";
            l_Html += "            <th>Deficit&nbsp;(Leader)</th>\n";
            l_Html += "            <th>Deficit&nbsp;(Ahead)</th>\n";
            l_Html += "          </tr>\n";
            
            var l_Pos = 1;
            
            l_RaceTime = "Fastest";
            l_WinrTime = "Fastest";
            
            for (l_Player of l_Result.childNodes) {
              if (l_Player.tagName == "raceplayer") {
                var l_Name = getNodeValue(l_Player.getElementsByTagName("id"));
                var l_Fast = parseInt(getNodeValue(l_Player.getElementsByTagName("fastest"))) / 120.0;
                var l_Time = parseInt(l_Player.getElementsByTagName("racetime")[0].getAttribute("total")) / 120.0;
                var l_Ahed = 0.0;
                var l_Ledr = 0.0;
                
                if (l_Fast == 0.0) {
                  l_Fast = "No laptime set.";
                }
                else {
                  l_Fast = l_Fast.toFixed(2) + "&nbsp;sec.";
                }
                
                if (l_RaceTime == "Fastest") {
                  l_RaceTime = l_Time;
                }
                
                if (l_WinrTime == "Fastest") {
                  l_WinrTime = l_Time;
                }
                
                console.log(l_Time + " / " + l_RaceTime);
                
                if (l_Time < l_RaceTime) {
                  l_Time = "Did not finish.";
                  l_Ledr = "Did not finish.";
                  l_Ahed = "Did not finish.";
                }
                else {
                  l_Ahed = (l_Time - l_RaceTime).toFixed(2) + "&nbsp;sec.";
                  l_Ledr = (l_Time - l_WinrTime).toFixed(2) + "&nbsp;sec.";
                  l_RaceTime = l_Time;
                  l_Time = l_Time.toFixed(2) + "&nbsp;sec.";
                }
                
                for (l_Marble of l_Assignment.childNodes) {
                  if (l_Marble.tagName == "assignment") {
                    if (parseInt(l_Name) == parseInt(l_Marble.getAttribute("marble"))) {
                      l_Name = l_Marble.getAttribute("player");
                      
                      for (l_ThePlayer of l_PlayerList) {
                        if (l_Name == l_ThePlayer["id"]) {
                          l_Name = l_ThePlayer["name"];
                        }
                      }
                      break;
                    }
                  }
                }
                
                l_Html += "          <tr>\n";
                l_Html += "            <td style=\"text-align: center\">" + l_Pos + "</td>\n";
                l_Html += "            <td>" + l_Name + "</td>\n";
                l_Html += "            <td style=\"text-align: right\">" + getNodeValue(l_Player.getElementsByTagName("respawn")) + "</td>\n";
                l_Html += "            <td style=\"text-align: right\">" + getNodeValue(l_Player.getElementsByTagName("stunned")) + "</td>\n";
                l_Html += "            <td style=\"text-align: right\">" + l_Time + "</td>\n";
                l_Html += "            <td style=\"text-align: right\">" + l_Fast + "</td>\n";
                l_Html += "            <td style=\"text-align: right\">" + l_Ledr + "</td>\n";
                l_Html += "            <td style=\"text-align: right\">" + l_Ahed + "</td>\n";
                l_Html += "          </tr>\n";
                l_Pos++;
              }
            }
            
            l_Html += "        </table>\n";
            l_Html += "      </div>\n";
          
            l_Count++;
          }
        }
        
        l_Html += "        <div>\n";
        
        l_MainFrame.html(l_Html);
        $("#accordion").accordion();
      });
    
    </script>
  </head>
  <body>
    <div class="container">
      <div id="headline">
        Dustbin::Games MarbleGP - Result of last Championship
      </div>
    </div>
    <div class="container">
      <div id="mainframe">
      </div>
    </div>
    <div class="container" style="padding-top: 1em"><img src="marblegp_logo.png" class="logoimg" /></div>
  </body>
</html>
